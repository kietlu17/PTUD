--
-- PostgreSQL database dump CLEANED & UPDATED
--

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

-- 1. RESET SCHEMA (Xóa dữ liệu cũ để nạp mới sạch sẽ)
DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;

SET default_tablespace = '';
SET default_table_access_method = heap;

--
-- 2. TẠO CÁC BẢNG
--

CREATE TABLE public."BaiNop" (
    id integer NOT NULL,
    "id_BaiTap" integer,
    "id_HocSinh" integer,
    "NgayNop" timestamp without time zone,
    file_path character varying(255),
    "DiemSo" numeric(4,2),
    "NhanXet" text,
    "NgayCham" timestamp without time zone,
    "TrangThai" character varying(20)
);

CREATE TABLE public."BaiTap" (
    id integer NOT NULL,
    "TieuDe" character varying(255),
    "NoiDung" text,
    "id_MonHoc" integer,
    "id_Lop" integer,
    "id_GiaoVien" integer,
    "NgayGiao" timestamp without time zone,
    "HanNop" timestamp without time zone,
    "File" character varying(255),
    "TrangThai" character varying(20)
);

CREATE TABLE public."BanGiamHieu" (
    id integer NOT NULL,
    id_truong integer,
    "MaBGV" character varying(255),
    "HoVaTen" character varying(255),
    "NgaySinh" date,
    "GioiTinh" character varying(10),
    "SDT" character varying(15),
    "DiaChi" character varying(255),
    email character varying(255)
);

CREATE TABLE public."BangPhanCongGiaoVien" (
    id integer NOT NULL GENERATED ALWAYS AS IDENTITY,
    "id_GiaoVien" integer NOT NULL,
    "id_MonHoc" integer NOT NULL,
    "id_Lop" integer NOT NULL,
    "KyHoc" character varying(10),
    "NamHoc" character varying(20),
    "NgayPhanCong" timestamp with time zone
);

CREATE TABLE public."BangPhanCongGiaoVienChuNhiem" (
    id integer NOT NULL GENERATED ALWAYS AS IDENTITY,
    "id_GiaoVien" integer,
    "id_Lop" integer,
    "NamHoc" character varying(20),
    "NgayPhanCong" timestamp without time zone
);

CREATE TABLE public."ChiTiet_ToHopMon" (
    subject_group_id integer NOT NULL,
    subject_id integer NOT NULL,
    "Note" character varying(255)
);

CREATE TABLE public."DiemDanh" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    student_id integer NOT NULL,
    lop_id integer NOT NULL,
    monhoc_id integer,
    giaovien_id integer NOT NULL,
    "NgayHoc" date NOT NULL,
    "TinhTrang" character varying(255) NOT NULL,
    created_at timestamp with time zone
);

CREATE TABLE public."NghiHoc" (
    application_id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    student_id integer NOT NULL,
    "NgayNghi" date NOT NULL,
    "LyDo" character varying(255) NOT NULL,
    "TinhTrang" character varying(50),
    "NgayNop" timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    pproved_by integer
);

CREATE TABLE public."DiemSo" (
    id integer NOT NULL,
    "id_HocSinh" integer,
    "id_MonHoc" integer,
    "HocKy" character varying(10),
    "NamHoc" character varying(20),
    "DiemThuongKy" numeric(4,2),
    "DiemGiuaKy" numeric(4,2),
    "DiemCuoiKy" numeric(4,2),
    "DiemTrungBinh" numeric(4,2)
);

CREATE TABLE public."DiemThi" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    thisinhid integer NOT NULL,
    toan double precision,
    nguvan double precision,
    tienganh double precision,
    tong double precision
);

-- [ĐÃ SỬA] Thêm cột id_MonHoc vào bảng GiaoVien
CREATE TABLE public."GiaoVien" (
    id integer NOT NULL,
    "HoVaTen" character varying(255) NOT NULL,
    "NgaySinh" date NOT NULL,
    "GioiTinh" character varying(255) NOT NULL,
    "ViTri" character varying(255) NOT NULL,
    "SDT" character varying(255) NOT NULL,
    "DiaChi" character varying(255) NOT NULL,
    email character varying(255) NOT NULL,
    "NgayThamGia" date NOT NULL,
    id_truong integer,
    "MaGV" character varying(255) NOT NULL,
    "id_MonHoc" integer  -- <--- CỘT MỚI THÊM
);

CREATE TABLE public."HanhKiem" (
    id integer NOT NULL GENERATED ALWAYS AS IDENTITY,
    "id_HocSinh" integer,
    "HocKy" character varying(10),
    "NamHoc" character varying(20),
    "LoaiHanhKiem" character varying(20),
    "NhanXet" text,
    "NguoiDanhGia" integer,
    "NgayDanhGia" timestamp with time zone
);

CREATE TABLE public."HocBa" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "id_HocSinh" integer,
    "id_Lop" integer,
    "id_Truong" integer,
    "NamHoc" character varying(20),
    "HocKy" character varying(10),
    "DiemTrungBinh" numeric(4,2),
    "HanhKiem" character varying(20),
    "NhanXet" text
);

CREATE TABLE public."HocSinh" (
    id integer NOT NULL,
    "MaHS" character varying(255) NOT NULL,
    "HoVaTen" character varying(255) NOT NULL,
    "NgaySinh" date NOT NULL,
    "GioiTinh" character varying(255) NOT NULL,
    "id_Lop" integer NOT NULL,
    id_school integer NOT NULL
);

CREATE TABLE public."LichSuDiem" (
    id integer NOT NULL,
    "id_DiemSo" integer,
    "LoaiDiem" character varying(50),
    "DiemCu" numeric(4,2),
    "DiemMoi" numeric(4,2),
    "NguoiSua" integer,
    "ThoiGian" timestamp without time zone,
    "LyDo" text
);

CREATE TABLE public."Lop" (
    id integer NOT NULL,
    "TenLop" character varying(10),
    "id_ToHopMon" integer,
    "id_GiaoVienChuNhiem" integer,
    id_truong integer
);

CREATE TABLE public."MonHoc" (
    id integer NOT NULL,
    "TenMon" character varying(255) NOT NULL,
    "SoTiet" integer
);

CREATE TABLE public."NhanVienSo" (
    "HoTen" character varying(255),
    "GioiTinh" character varying(255),
    "NgaySinh" date,
    "ChucVu" character varying(255),
    "Email" character varying(255),
    "SoDT" character varying(255),
    "TrangThai" character varying(255),
    "TaiKhoanID" integer,
    "ID" integer,
    "MaSGD" character varying(255) NOT NULL
);

CREATE TABLE public."NhanXetHocTap" (
    id integer NOT NULL,
    "id_HocSinh" integer,
    "id_GiaoVien" integer,
    "HocKy" character varying(10),
    "NamHoc" character varying(20),
    "NoiDung" text,
    "NgayTao" timestamp without time zone
);

CREATE TABLE public."PhongThi" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    name character varying(50) NOT NULL,
    truongid integer
);

CREATE TABLE public."PhuHuynh" (
    id integer NOT NULL,
    "MaPH" character varying(255),
    "HoVaTen" character varying(255),
    "id_HocSinh" integer,
    "SDT" character varying(15),
    email character varying(255),
    "NgaySinh" date,
    "GioiTinh" character varying(10)
);

CREATE TABLE public."QuanTriTruong" (
    id integer NOT NULL,
    "MaQTV" character varying(255),
    "HoVaTen" character varying(255),
    "NgaySinh" date,
    "GioiTinh" character varying(10),
    id_school integer NOT NULL
);

CREATE TABLE public."TaiKhoan" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    username character varying(255) NOT NULL,
    password character varying(255) NOT NULL,
    id_role integer NOT NULL
);

CREATE TABLE public."ThanhToanHocPhi" (
    id integer NOT NULL,
    "id_HocSinh" integer,
    "HocKy" character varying(10),
    "NamHoc" character varying(20),
    "CongNo" numeric(12,2),
    "TienDaNop" numeric(12,2),
    "NgayThanhToan" timestamp with time zone,
    "PhuongThuc" character varying(50),
    "TrangThai" character varying(20)
);

CREATE TABLE public."ThiSinh" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    mahs character varying(10) NOT NULL,
    hoten character varying(50) NOT NULL,
    ngaysinh timestamp with time zone,
    phongthiid integer NOT NULL
);

CREATE TABLE public."ThoiKhoaBieu" (
    id integer NOT NULL,
    "id_Lop" integer,
    "id_MonHoc" integer,
    "id_GiaoVien" integer,
    "Thu" character varying(10),
    "Tiet" integer,
    "HocKy" character varying(10),
    "NamHoc" character varying(20)
);

CREATE TABLE public."ThongBao" (
    id integer NOT NULL,
    "TieuDe" character varying(255),
    "NoiDung" text,
    "NguoiDang" integer,
    "NgayDang" timestamp without time zone,
    "NgayCapNhat" timestamp without time zone
);

CREATE TABLE public."ToHopMon" (
    id integer NOT NULL,
    "TenToHop" character varying(255) NOT NULL,
    mota character varying(255)
);

CREATE TABLE public."Truong" (
    id integer NOT NULL,
    name character varying(255)
);

CREATE TABLE public."VaiTro" (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "TenVaiTro" character varying(255) NOT NULL,
    mota character varying(255)
);

CREATE TABLE public."YeuCauSuaDiem" (
    id integer NOT NULL,
    "id_DiemSo" integer,
    "id_GiaoVien" integer,
    "NgayGui" timestamp without time zone,
    "LoaiDiem" character varying(50),
    "DiemCu" numeric(4,2),
    "DiemMoi" numeric(4,2),
    "LyDo" text,
    "TrangThai" character varying(20),
    "NguoiDuyet" integer,
    "ThoiGianDuyet" timestamp without time zone
);

-- 3. PRIMARY KEYS
ALTER TABLE ONLY public."BaiNop" ADD CONSTRAINT "BaiNop_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."BaiTap" ADD CONSTRAINT "BaiTap_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."BanGiamHieu" ADD CONSTRAINT "BanGiamHieu_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."BangPhanCongGiaoVienChuNhiem" ADD CONSTRAINT "BangPhanCongGiaoVienChuNhiem_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."BangPhanCongGiaoVien" ADD CONSTRAINT "BangPhanCongGiaoVien_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."ChiTiet_ToHopMon" ADD CONSTRAINT "ChiTiet_ToHopMon_pkey" PRIMARY KEY (subject_group_id, subject_id);
ALTER TABLE ONLY public."NghiHoc" ADD CONSTRAINT "DiemDanh_pkey" PRIMARY KEY (application_id);
ALTER TABLE ONLY public."DiemDanh" ADD CONSTRAINT "DiemDanh_pkey1" PRIMARY KEY (id);
ALTER TABLE ONLY public."DiemSo" ADD CONSTRAINT "DiemSo_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."DiemThi" ADD CONSTRAINT "DiemThi_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."GiaoVien" ADD CONSTRAINT "GiaoVien_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."HanhKiem" ADD CONSTRAINT "HanhKiem_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."HocBa" ADD CONSTRAINT "HocBa_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."HocSinh" ADD CONSTRAINT "HocSinh_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."LichSuDiem" ADD CONSTRAINT "LichSuDiem_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."Lop" ADD CONSTRAINT "Lop_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."MonHoc" ADD CONSTRAINT "MonHoc_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."NhanXetHocTap" ADD CONSTRAINT "NhanXetHocTap_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."PhongThi" ADD CONSTRAINT "PhongThi_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."PhuHuynh" ADD CONSTRAINT "PhuHuynh_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."QuanTriTruong" ADD CONSTRAINT "QuaTriTruong_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."TaiKhoan" ADD CONSTRAINT "TaiKhoan_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."ThanhToanHocPhi" ADD CONSTRAINT "ThanhToanHocPhi_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."ThiSinh" ADD CONSTRAINT "ThiSinh_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."ThoiKhoaBieu" ADD CONSTRAINT "ThoiKhoaBieu_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."ThongBao" ADD CONSTRAINT "ThongBao_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."ToHopMon" ADD CONSTRAINT "ToHopMon_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."Truong" ADD CONSTRAINT "Truong_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."VaiTro" ADD CONSTRAINT "VaiTro_pkey" PRIMARY KEY (id);
ALTER TABLE ONLY public."YeuCauSuaDiem" ADD CONSTRAINT "YeuCauSuaDiem_pkey" PRIMARY KEY (id);

-- 4. UNIQUE CONSTRAINTS
ALTER TABLE ONLY public."GiaoVien" ADD CONSTRAINT "GiaoVien_MaGV_key" UNIQUE ("MaGV");
ALTER TABLE ONLY public."HocSinh" ADD CONSTRAINT "HocSinh_MaHS_key" UNIQUE ("MaHS");
ALTER TABLE ONLY public."NhanVienSo" ADD CONSTRAINT "NhanVienSo_MaSGD_key" UNIQUE ("MaSGD");
ALTER TABLE ONLY public."TaiKhoan" ADD CONSTRAINT "TaiKhoan_username_key" UNIQUE (username);
ALTER TABLE ONLY public."ThiSinh" ADD CONSTRAINT "ThiSinh_mahs_key" UNIQUE (mahs);

-- 5. NẠP DỮ LIỆU (DATA)
COPY public."MonHoc" (id, "TenMon", "SoTiet") FROM stdin;
1	Toán	45
2	Văn	45
3	Anh	45
\.

COPY public."Truong" (id, name) FROM stdin;
1	Trường THPT Phú Mỹ
2	Trường THPT Nguyễn Trãi
\.

-- Giao Vien Data (Sẽ update id_MonHoc sau)
COPY public."GiaoVien" (id, "HoVaTen", "NgaySinh", "GioiTinh", "ViTri", "SDT", "DiaChi", email, "NgayThamGia", id_truong, "MaGV") FROM stdin;
2	Trần Thị D	1985-07-25	Nữ	Giáo viên Văn	0987654321	TP. HCM	tranthid@example.com	2010-09-01	1	giaovien2
1	Nguyễn Văn C	1980-03-10	Nam	Giáo viên Toán	0123456789	TP. HCM	nguyenvanc@example.com	2005-09-01	1	THP.GV.2025.0001
3	Lê Thị Mới	1980-03-10	Nữ	Giáo viên Anh	0123456789	TP. HCM	lethimoi@example.com	2025-09-01	1	THP.GV.2025.0002
\.

COPY public."ToHopMon" (id, "TenToHop", mota) FROM stdin;
1	Khoa học tự nhiên	Toán, Lý, Hóa
2	Khoa học xã hội	Văn, Sử, Địa
\.

COPY public."Lop" (id, "TenLop", "id_ToHopMon", "id_GiaoVienChuNhiem", id_truong) FROM stdin;
2	10A2	2	2	1
1	10A1	1	1	1
3	11A1	1	\N	1
\.

COPY public."HocSinh" (id, "MaHS", "HoVaTen", "NgaySinh", "GioiTinh", "id_Lop", id_school) FROM stdin;
1	hocsinh1	Nguyễn Văn A	2010-05-15	Nam	2	2
2	THP.HS.2025.0001	Trần Thị B	2011-08-20	Nữ	1	1
\.

COPY public."BaiTap" (id, "TieuDe", "NoiDung", "id_MonHoc", "id_Lop", "id_GiaoVien", "NgayGiao", "HanNop", "File", "TrangThai") FROM stdin;
1	Bài tập Toán tuần 1	Giải các bài tập trong sách giáo khoa	1	1	1	2025-09-01 00:00:00	2025-09-07 00:00:00	baitap1.pdf	Đang giao
\.

COPY public."BaiNop" (id, "id_BaiTap", "id_HocSinh", "NgayNop", file_path, "DiemSo", "NhanXet", "NgayCham", "TrangThai") FROM stdin;
1	1	1	2025-09-05 00:00:00	baitap1_hocsinh1.pdf	9.00	Bài làm tốt	2025-09-06 00:00:00	Đã chấm
\.

COPY public."BanGiamHieu" (id, id_truong, "MaBGV", "HoVaTen", "NgaySinh", "GioiTinh", "SDT", "DiaChi", email) FROM stdin;
1	1	bangiamhieu1	Nguyễn Văn E	1970-01-01	Nam	0123456789	TP. HCM	bangiamhieu1@example.com
2	2	bangiamhieu2	Trần Thị F	1975-02-02	Nữ	0987654321	TP. HCM	bangiamhieu2@example.com
\.

COPY public."BangPhanCongGiaoVien" (id, "id_GiaoVien", "id_MonHoc", "id_Lop", "KyHoc", "NamHoc", "NgayPhanCong") FROM stdin;
1	1	1	1	1	2025-2026	2025-08-15 00:00:00+00
2	2	2	2	1	2025-2026	2025-08-15 00:00:00+00
\.

COPY public."BangPhanCongGiaoVienChuNhiem" (id, "id_GiaoVien", "id_Lop", "NamHoc", "NgayPhanCong") FROM stdin;
1	1	1	2025-2026	2025-08-15 00:00:00
2	2	2	2025-2026	2025-08-15 00:00:00
\.

COPY public."DiemDanh" (id, student_id, lop_id, monhoc_id, giaovien_id, "NgayHoc", "TinhTrang", created_at) FROM stdin;
1	1	1	1	1	2025-10-29	Có mặt	2025-10-29 00:00:00+00
4	1	1	1	1	2025-10-30	Vắng	2025-10-30 02:23:09.25+00
5	2	1	1	1	2025-10-30	Vắng	2025-10-30 02:23:09.262+00
6	1	1	1	1	2025-10-30	Vắng	2025-10-30 05:45:00.402+00
7	2	1	1	1	2025-10-30	Có mặt	2025-10-30 05:45:00.43+00
8	1	1	1	1	2025-10-30	Vắng	2025-10-30 05:48:11.417+00
9	2	1	1	1	2025-10-30	Có mặt	2025-10-30 05:48:11.481+00
10	1	1	1	1	2025-11-16	Có mặt	2025-11-16 09:28:44.187+00
11	2	1	1	1	2025-11-16	Có mặt	2025-11-16 09:28:44.203+00
12	2	1	1	1	2025-11-16	Trễ	2025-11-16 12:39:11.456+00
13	2	1	1	1	2025-11-17	Có mặt	2025-11-17 13:07:11.549+00
14	2	1	1	1	2025-11-17	Có mặt	2025-11-17 13:07:50.607+00
15	2	1	1	1	2025-11-17	Có mặt	2025-11-17 13:29:33.449+00
16	2	1	1	1	2025-11-17	Có mặt	2025-11-17 13:29:47.594+00
\.

COPY public."DiemSo" (id, "id_HocSinh", "id_MonHoc", "HocKy", "NamHoc", "DiemThuongKy", "DiemGiuaKy", "DiemCuoiKy", "DiemTrungBinh") FROM stdin;
1	1	1	1	2025-2026	8.50	7.00	9.00	8.20
2	2	2	1	2025-2026	7.50	8.00	8.50	8.00
\.

COPY public."PhongThi" (id, name, truongid) FROM stdin;
1	Phòng 101	1
2	Phòng 102	1
3	Phòng 201	2
4	Phòng 202	2
\.

COPY public."ThiSinh" (id, mahs, hoten, ngaysinh, phongthiid) FROM stdin;
11	PM10101	Nguyễn Văn A	2008-05-10 00:00:00+00	1
12	PM10102	Trần Thị B	2008-07-22 00:00:00+00	1
13	PM10103	Lê Văn C	2008-08-13 00:00:00+00	1
14	PM10104	Phạm Thị D	2008-11-05 00:00:00+00	1
15	PM10105	Hoàng Văn E	2008-02-17 00:00:00+00	1
16	NT20101	Ngô Văn F	2008-03-02 00:00:00+00	3
17	NT20102	Phan Thị G	2008-06-18 00:00:00+00	3
18	NT20103	Đinh Văn H	2008-09-09 00:00:00+00	3
19	NT20104	Bùi Thị I	2008-12-11 00:00:00+00	3
20	NT20105	Vũ Văn K	2008-01-25 00:00:00+00	3
\.

COPY public."DiemThi" (id, thisinhid, toan, nguvan, tienganh, tong) FROM stdin;
11	11	5	6	7	18
12	12	1	1	1	3
13	15	2	2	2	6
\.

COPY public."HanhKiem" (id, "id_HocSinh", "HocKy", "NamHoc", "LoaiHanhKiem", "NhanXet", "NguoiDanhGia", "NgayDanhGia") FROM stdin;
1	1	1	2025-2026	Yếu	1	1	2025-11-16 12:19:09.492+00
5	2	1	2025-2026	Khá	ok	1	2025-11-17 13:12:39.557+00
\.

COPY public."HocBa" (id, "id_HocSinh", "id_Lop", "id_Truong", "NamHoc", "HocKy", "DiemTrungBinh", "HanhKiem", "NhanXet") FROM stdin;
1	1	1	1	2025-2026	1	8.20	Tốt	Học sinh chăm chỉ, tiến bộ
\.

COPY public."LichSuDiem" (id, "id_DiemSo", "LoaiDiem", "DiemCu", "DiemMoi", "NguoiSua", "ThoiGian", "LyDo") FROM stdin;
1	1	DiemThuongKy	8.00	8.50	1	2025-09-10 00:00:00	Cập nhật điểm do nhập sai
\.

COPY public."NghiHoc" (application_id, student_id, "NgayNghi", "LyDo", "TinhTrang", "NgayNop", pproved_by) FROM stdin;
1	1	2025-09-01	Ốm	Đã duyệt	2025-09-02 00:00:00	1
2	2	2025-09-03	Gia đình có việc	Đã duyệt	2025-09-04 00:00:00	2
\.

COPY public."NhanVienSo" ("HoTen", "GioiTinh", "NgaySinh", "ChucVu", "Email", "SoDT", "TrangThai", "TaiKhoanID", "ID", "MaSGD") FROM stdin;
Nguyễn Văn An	nam	1985-01-01	Chuyên viên Sở	sgd@gmail.com	012345	Đang hoạt động	5	1	sogiaoduc1
\.

COPY public."NhanXetHocTap" (id, "id_HocSinh", "id_GiaoVien", "HocKy", "NamHoc", "NoiDung", "NgayTao") FROM stdin;
1	1	1	1	2025-2026	Học sinh chăm chỉ, tiến bộ	2025-09-15 00:00:00
\.

COPY public."PhuHuynh" (id, "MaPH", "HoVaTen", "id_HocSinh", "SDT", email, "NgaySinh", "GioiTinh") FROM stdin;
1	phuhuynh1	Nguyễn Văn C	1	0123456789	phuhuynh1@example.com	1980-03-10	Nam
2	phuhuynh2	Trần Thị D	2	0987654321	phuhuynh2@example.com	1985-07-25	Nữ
\.

COPY public."QuanTriTruong" (id, "MaQTV", "HoVaTen", "NgaySinh", "GioiTinh", id_school) FROM stdin;
1	admin1	Quản trị 1	1985-01-01	nam	1
\.

COPY public."VaiTro" (id, "TenVaiTro", mota) FROM stdin;
1	học sinh	Vai trò học sinh
2	phụ huynh	Vai trò phụ huynh
3	giáo viên	Vai trò giáo viên
4	ban giám hiệu	Vai trò ban giám hiệu
5	sở giáo dục	Vai trò sở giáo dục
6	admin	Quản trị viên
\.

COPY public."TaiKhoan" (id, username, password, id_role) FROM stdin;
1	hocsinh1	1	1
3	giaovien1	1	3
4	bangiamhieu1	1	4
7	THP.HS.2025.0001	$2b$10$qF037N0BseutL1OE17LZruX1e8AkENItkfQlS6gkJDghnUbpqyE9K	1
2	phuhuynh1	$2b$10$qF037N0BseutL1OE17LZruX1e8AkENItkfQlS6gkJDghnUbpqyE9K	2
6	admin1	admin	6
5	sogiaoduc1	$2b$10$qF037N0BseutL1OE17LZruX1e8AkENItkfQlS6gkJDghnUbpqyE9K	5
8	THP.GV.2025.0001	$2b$10$qF037N0BseutL1OE17LZruX1e8AkENItkfQlS6gkJDghnUbpqyE9K	3
\.

COPY public."ThanhToanHocPhi" (id, "id_HocSinh", "HocKy", "NamHoc", "CongNo", "TienDaNop", "NgayThanhToan", "PhuongThuc", "TrangThai") FROM stdin;
1	1	1	2025-2026	5000000.00	2500000.00	2025-09-01 00:00:00+00	Chuyển khoản	Đã thanh toán
\.

COPY public."ThoiKhoaBieu" (id, "id_Lop", "id_MonHoc", "id_GiaoVien", "Thu", "Tiet", "HocKy", "NamHoc") FROM stdin;
1	1	1	1	Hai	1	1	2025-2026
\.

COPY public."ThongBao" (id, "TieuDe", "NoiDung", "NguoiDang", "NgayDang", "NgayCapNhat") FROM stdin;
1	Thông báo nghỉ học	Học sinh nghỉ học ngày 01/09/2025	1	2025-08-30 00:00:00	2025-08-30 00:00:00
\.

COPY public."YeuCauSuaDiem" (id, "id_DiemSo", "id_GiaoVien", "NgayGui", "LoaiDiem", "DiemCu", "DiemMoi", "LyDo", "TrangThai", "NguoiDuyet", "ThoiGianDuyet") FROM stdin;
1	1	1	2025-09-05 00:00:00	DiemThuongKy	8.00	8.50	Cập nhật điểm do nhập sai	Đã duyệt	2	2025-09-06 00:00:00
\.


-- 6. FOREIGN KEYS & CONSTRAINTS
ALTER TABLE ONLY public."BaiNop" ADD CONSTRAINT "BaiNop_id_BaiTap_fkey" FOREIGN KEY ("id_BaiTap") REFERENCES public."BaiTap"(id);
ALTER TABLE ONLY public."BaiNop" ADD CONSTRAINT "BaiNop_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id);
ALTER TABLE ONLY public."BaiTap" ADD CONSTRAINT "BaiTap_id_GiaoVien_fkey" FOREIGN KEY ("id_GiaoVien") REFERENCES public."GiaoVien"(id);
ALTER TABLE ONLY public."BaiTap" ADD CONSTRAINT "BaiTap_id_Lop_fkey" FOREIGN KEY ("id_Lop") REFERENCES public."Lop"(id);
ALTER TABLE ONLY public."BaiTap" ADD CONSTRAINT "BaiTap_id_MonHoc_fkey" FOREIGN KEY ("id_MonHoc") REFERENCES public."MonHoc"(id);
ALTER TABLE ONLY public."BangPhanCongGiaoVienChuNhiem" ADD CONSTRAINT "BangPhanCongGiaoVienChuNhiem_id_GiaoVien_fkey" FOREIGN KEY ("id_GiaoVien") REFERENCES public."GiaoVien"(id);
ALTER TABLE ONLY public."BangPhanCongGiaoVienChuNhiem" ADD CONSTRAINT "BangPhanCongGiaoVienChuNhiem_id_Lop_fkey" FOREIGN KEY ("id_Lop") REFERENCES public."Lop"(id);
ALTER TABLE ONLY public."BangPhanCongGiaoVien" ADD CONSTRAINT "BangPhanCongGiaoVien_id_GiaoVien_fkey" FOREIGN KEY ("id_GiaoVien") REFERENCES public."GiaoVien"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."BangPhanCongGiaoVien" ADD CONSTRAINT "BangPhanCongGiaoVien_id_Lop_fkey" FOREIGN KEY ("id_Lop") REFERENCES public."Lop"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."BangPhanCongGiaoVien" ADD CONSTRAINT "BangPhanCongGiaoVien_id_MonHoc_fkey" FOREIGN KEY ("id_MonHoc") REFERENCES public."MonHoc"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."ChiTiet_ToHopMon" ADD CONSTRAINT "ChiTiet_ToHopMon_subject_group_id_fkey" FOREIGN KEY (subject_group_id) REFERENCES public."ToHopMon"(id);
ALTER TABLE ONLY public."ChiTiet_ToHopMon" ADD CONSTRAINT "ChiTiet_ToHopMon_subject_id_fkey" FOREIGN KEY (subject_id) REFERENCES public."MonHoc"(id);
ALTER TABLE ONLY public."DiemDanh" ADD CONSTRAINT "DiemDanh_giaovien_id_fkey" FOREIGN KEY (giaovien_id) REFERENCES public."GiaoVien"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."DiemDanh" ADD CONSTRAINT "DiemDanh_lop_id_fkey" FOREIGN KEY (lop_id) REFERENCES public."Lop"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."DiemDanh" ADD CONSTRAINT "DiemDanh_monhoc_id_fkey" FOREIGN KEY (monhoc_id) REFERENCES public."MonHoc"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."NghiHoc" ADD CONSTRAINT "DiemDanh_pproved_by_fkey" FOREIGN KEY (pproved_by) REFERENCES public."GiaoVien"(id);
ALTER TABLE ONLY public."NghiHoc" ADD CONSTRAINT "DiemDanh_student_id_fkey" FOREIGN KEY (student_id) REFERENCES public."HocSinh"(id);
ALTER TABLE ONLY public."DiemDanh" ADD CONSTRAINT "DiemDanh_student_id_fkey1" FOREIGN KEY (student_id) REFERENCES public."HocSinh"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."DiemSo" ADD CONSTRAINT "DiemSo_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."DiemSo" ADD CONSTRAINT "DiemSo_id_MonHoc_fkey" FOREIGN KEY ("id_MonHoc") REFERENCES public."MonHoc"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."DiemThi" ADD CONSTRAINT "DiemThi_thisinhid_fkey" FOREIGN KEY (thisinhid) REFERENCES public."ThiSinh"(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY public."GiaoVien" ADD CONSTRAINT "GiaoVien_id_truong_fkey" FOREIGN KEY (id_truong) REFERENCES public."Truong"(id) ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ONLY public."HanhKiem" ADD CONSTRAINT "HanhKiem_NguoiDanhGia_fkey" FOREIGN KEY ("NguoiDanhGia") REFERENCES public."GiaoVien"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."HanhKiem" ADD CONSTRAINT "HanhKiem_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."HocBa" ADD CONSTRAINT "HocBa_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id);
ALTER TABLE ONLY public."HocBa" ADD CONSTRAINT "HocBa_id_Lop_fkey" FOREIGN KEY ("id_Lop") REFERENCES public."Lop"(id);
ALTER TABLE ONLY public."HocBa" ADD CONSTRAINT "HocBa_id_Truong_fkey" FOREIGN KEY ("id_Truong") REFERENCES public."Truong"(id);
ALTER TABLE ONLY public."HocSinh" ADD CONSTRAINT "HocSinh_id_Lop_fkey" FOREIGN KEY ("id_Lop") REFERENCES public."Lop"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."HocSinh" ADD CONSTRAINT "HocSinh_id_school_fkey" FOREIGN KEY (id_school) REFERENCES public."Truong"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."LichSuDiem" ADD CONSTRAINT "LichSuDiem_NguoiSua_fkey" FOREIGN KEY ("NguoiSua") REFERENCES public."GiaoVien"(id);
ALTER TABLE ONLY public."LichSuDiem" ADD CONSTRAINT "LichSuDiem_id_DiemSo_fkey" FOREIGN KEY ("id_DiemSo") REFERENCES public."DiemSo"(id);
ALTER TABLE ONLY public."Lop" ADD CONSTRAINT "Lop_id_GiaoVienChuNhiem_fkey" FOREIGN KEY ("id_GiaoVienChuNhiem") REFERENCES public."GiaoVien"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."Lop" ADD CONSTRAINT "Lop_id_ToHopMon_fkey" FOREIGN KEY ("id_ToHopMon") REFERENCES public."ToHopMon"(id);
ALTER TABLE ONLY public."Lop" ADD CONSTRAINT "Lop_id_truong_fkey" FOREIGN KEY (id_truong) REFERENCES public."Truong"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."NhanXetHocTap" ADD CONSTRAINT "NhanXetHocTap_id_GiaoVien_fkey" FOREIGN KEY ("id_GiaoVien") REFERENCES public."GiaoVien"(id);
ALTER TABLE ONLY public."NhanXetHocTap" ADD CONSTRAINT "NhanXetHocTap_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id);
ALTER TABLE ONLY public."PhongThi" ADD CONSTRAINT "PhongThi_truongid_fkey" FOREIGN KEY (truongid) REFERENCES public."Truong"(id);
ALTER TABLE ONLY public."PhuHuynh" ADD CONSTRAINT "PhuHuynh_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE ONLY public."QuanTriTruong" ADD CONSTRAINT "QuanTriTruong_id_school_fkey" FOREIGN KEY (id_school) REFERENCES public."Truong"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."TaiKhoan" ADD CONSTRAINT "TaiKhoan_id_role_fkey" FOREIGN KEY (id_role) REFERENCES public."VaiTro"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."ThanhToanHocPhi" ADD CONSTRAINT "ThanhToanHocPhi_id_HocSinh_fkey" FOREIGN KEY ("id_HocSinh") REFERENCES public."HocSinh"(id);
ALTER TABLE ONLY public."ThiSinh" ADD CONSTRAINT "ThiSinh_phongthiid_fkey" FOREIGN KEY (phongthiid) REFERENCES public."PhongThi"(id) ON UPDATE CASCADE;
ALTER TABLE ONLY public."ThoiKhoaBieu" ADD CONSTRAINT "ThoiKhoaBieu_id_GiaoVien_fkey" FOREIGN KEY ("id_GiaoVien") REFERENCES public."GiaoVien"(id);
ALTER TABLE ONLY public."ThoiKhoaBieu" ADD CONSTRAINT "ThoiKhoaBieu_id_Lop_fkey" FOREIGN KEY ("id_Lop") REFERENCES public."Lop"(id);
ALTER TABLE ONLY public."ThoiKhoaBieu" ADD CONSTRAINT "ThoiKhoaBieu_id_MonHoc_fkey" FOREIGN KEY ("id_MonHoc") REFERENCES public."MonHoc"(id);
ALTER TABLE ONLY public."ThongBao" ADD CONSTRAINT "ThongBao_NguoiDang_fkey" FOREIGN KEY ("NguoiDang") REFERENCES public."BanGiamHieu"(id);
ALTER TABLE ONLY public."YeuCauSuaDiem" ADD CONSTRAINT "YeuCauSuaDiem_NguoiDuyet_fkey" FOREIGN KEY ("NguoiDuyet") REFERENCES public."BanGiamHieu"(id);
ALTER TABLE ONLY public."YeuCauSuaDiem" ADD CONSTRAINT "YeuCauSuaDiem_id_DiemSo_fkey" FOREIGN KEY ("id_DiemSo") REFERENCES public."DiemSo"(id);
ALTER TABLE ONLY public."YeuCauSuaDiem" ADD CONSTRAINT "YeuCauSuaDiem_id_GiaoVien_fkey" FOREIGN KEY ("id_GiaoVien") REFERENCES public."GiaoVien"(id);

-- [ĐÃ SỬA] Cập nhật dữ liệu GiaoVien để khớp chức năng (Gán môn học)
-- GiaoVien 1 (Toan) -> id_MonHoc = 1
UPDATE public."GiaoVien" SET "id_MonHoc" = 1 WHERE id = 1;
-- GiaoVien 2 (Van) -> id_MonHoc = 2
UPDATE public."GiaoVien" SET "id_MonHoc" = 2 WHERE id = 2;
-- GiaoVien 3 (Anh) -> id_MonHoc = 3
UPDATE public."GiaoVien" SET "id_MonHoc" = 3 WHERE id = 3;

-- Thêm Khóa Ngoại cho cột mới
ALTER TABLE ONLY public."GiaoVien"
    ADD CONSTRAINT "GiaoVien_id_MonHoc_fkey" FOREIGN KEY ("id_MonHoc") REFERENCES public."MonHoc"(id) ON UPDATE CASCADE ON DELETE SET NULL;

-- Set lại sequence để tránh lỗi id trùng khi insert mới
SELECT setval('public."DiemDanh_id_seq"', (SELECT MAX(id) FROM public."DiemDanh"));
SELECT setval('public."TaiKhoan_id_seq"', (SELECT MAX(id) FROM public."TaiKhoan"));
-- ... (đã có trong phần sequence ở trên nhưng chạy lại cho chắc)

-- ============================================================
-- 7. CẬP NHẬT SEQUENCE (RESET BỘ ĐẾM ID) - PHIÊN BẢN AN TOÀN
-- ============================================================

-- Sử dụng DO block để bắt lỗi nếu bảng chưa tồn tại
DO $$
BEGIN
    -- Reset bảng Phân công
    PERFORM setval(pg_get_serial_sequence('"BangPhanCongGiaoVien"', 'id'), COALESCE((SELECT MAX(id) FROM "BangPhanCongGiaoVien"), 0) + 1, false);
    PERFORM setval(pg_get_serial_sequence('"BangPhanCongGiaoVienChuNhiem"', 'id'), COALESCE((SELECT MAX(id) FROM "BangPhanCongGiaoVienChuNhiem"), 0) + 1, false);
    
    -- Reset các bảng khác (nếu có id tự tăng)
    -- Lưu ý: Chỉ chạy lệnh setval nếu cột id là SERIAL hoặc GENERATED ALWAYS AS IDENTITY
    
    -- Ví dụ với bảng Lop (nếu id tự tăng)
    -- PERFORM setval(pg_get_serial_sequence('"Lop"', 'id'), COALESCE((SELECT MAX(id) FROM "Lop"), 0) + 1, false);
    
EXCEPTION WHEN OTHERS THEN
    RAISE NOTICE 'Lỗi khi reset sequence: %', SQLERRM;
END $$;