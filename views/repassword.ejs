<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đổi mật khẩu lần đầu</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light d-flex align-items-center justify-content-center vh-100">

<div class="card shadow p-4" style="width: 420px;">
  <h4 class="text-center fw-bold mb-3">Đổi mật khẩu lần đầu</h4>
  <p class="text-muted text-center">
    Vì lý do bảo mật, vui lòng đổi mật khẩu trước khi tiếp tục.
  </p>

  <form id="changePasswordForm">
    <div class="mb-3">
      <label class="form-label">Mật khẩu mới</label>
      <input type="password" id="password" class="form-control" required>
      <small class="text-muted">
        Ít nhất 8 ký tự, gồm chữ hoa, chữ thường và số
      </small>
    </div>

    <div class="mb-3">
      <label class="form-label">Nhập lại mật khẩu</label>
      <input type="password" id="confirmPassword" class="form-control" required>
    </div>

    <button class="btn btn-primary w-100" type="submit">
      Xác nhận
    </button>
  </form>
</div>

<script>
const form = document.getElementById('changePasswordForm');

form.addEventListener('submit', async function (e) {
  e.preventDefault();

  const password = document.getElementById('password').value.trim();
  const confirmPassword = document.getElementById('confirmPassword').value.trim();

  // 1️ Kiểm tra trùng mật khẩu
  if (password !== confirmPassword) {
    return Swal.fire('Lỗi', 'Mật khẩu nhập lại không khớp', 'error');
  }

  // 2️ Kiểm tra độ mạnh mật khẩu
  const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
  if (!strongPasswordRegex.test(password)) {
    return Swal.fire(
      'Mật khẩu yếu',
      'Mật khẩu phải ≥ 8 ký tự, có chữ hoa, chữ thường và số',
      'warning'
    );
  }

  try {
    const res = await fetch('/account/re-password/<%= user.id %>', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });

    const data = await res.json();

    if (res.ok) {
      Swal.fire({
        title: 'Thành công',
        text: data.message || 'Đổi mật khẩu thành công',
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      }).then(() => {
        window.location.href = '/login';
      });
    } else {
      Swal.fire('Lỗi', data.message || 'Không thể đổi mật khẩu', 'error');
    }
  } catch (err) {
    Swal.fire('Lỗi', 'Có lỗi xảy ra', 'error');
  }
});
</script>

</body>
</html>
