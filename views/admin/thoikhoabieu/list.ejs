<%- include('../../partials/header', { title: 'Danh Sách Lớp' }) %>

<div class="container-fluid">
  <div class="row">
    <%- include('../../partials/nav-admin') %>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
      
      <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="fw-bold text-primary mb-0">Quản Lý Thời Khóa Biểu</h3>
          
          <div class="d-flex gap-2 bg-white p-2 rounded shadow-sm border">
              <select id="filterNamHoc" class="form-select form-select-sm fw-bold border-primary" style="width: 150px;" onchange="applyFilter()">
                  <% 
                     const currY = new Date().getFullYear();
                     const years = [`${currY-1}-${currY}`, `${currY}-${currY+1}`, `${currY+1}-${currY+2}`];
                  %>
                  <% years.forEach(y => { %>
                      <option value="<%= y %>" <%= selectedNamHoc === y ? 'selected' : '' %>><%= y %></option>
                  <% }) %>
              </select>

              <select id="filterHocKy" class="form-select form-select-sm fw-bold border-primary" style="width: 120px;" onchange="applyFilter()">
                  <option value="1" <%= selectedHocKy == '1' ? 'selected' : '' %>>Học kỳ 1</option>
                  <option value="2" <%= selectedHocKy == '2' ? 'selected' : '' %>>Học kỳ 2</option>
              </select>
          </div>
      </div>

      <div class="row g-4" id="classList">
          <% if (listLop && listLop.length > 0) { %>
              <% listLop.forEach(lop => { %>
                  <% 
                    const count = countMap[lop.id] || 0; 
                    let statusClass = '', statusText = '', btnText = 'Tạo Mới', borderClass = 'border-secondary';
                    
                    if (count === 0) {
                        statusClass = 'bg-secondary bg-opacity-10 text-secondary'; statusText = '⚪ Chưa có lịch';
                    } else if (count >= fullThreshold) {
                        statusClass = 'bg-success bg-opacity-10 text-success'; statusText = '✅ Đã hoàn tất'; 
                        btnText = 'Chỉnh Sửa'; borderClass = 'border-success';
                    } else {
                        statusClass = 'bg-warning bg-opacity-10 text-warning'; statusText = '⏳ Đang xếp'; 
                        btnText = 'Tiếp tục'; borderClass = 'border-warning';
                    }
                  %>

                  <div class="col-md-3 col-sm-6">
                      <div class="card h-100 shadow-sm hover-card <%= borderClass %>" style="border-width: 1px;">
                          <div class="card-body text-center">
                              <h5 class="fw-bold"><%= lop.TenLop %></h5>
                              <div class="mb-3"><span class="badge <%= statusClass %> border"><%= statusText %></span></div>
                              
                              <a href="/admin/thoikhoabieu/create?id_Lop=<%= lop.id %>&namHoc=<%= selectedNamHoc %>&hocKy=<%= selectedHocKy %>" 
                                 class="btn btn-outline-primary rounded-pill stretched-link btn-sm px-4">
                                 <%= btnText %>
                              </a>
                          </div>
                      </div>
                  </div>
              <% }) %>
          <% } %>
      </div>
    </main>
  </div>
</div>

<script>
    function applyFilter() {
        const nam = document.getElementById('filterNamHoc').value;
        const ky = document.getElementById('filterHocKy').value;
        // Reload trang với tham số mới
        window.location.href = `/admin/thoikhoabieu?namHoc=${nam}&hocKy=${ky}`;
    }
</script>