<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<%- include('../../partials/header', { title: 'Quản Lý Tài Khoản' }) %>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
<%- include('../../partials/nav-admin', { title: 'Quản Lý Tài Khoản' }) %>

    <!-- Main Content -->
    <main class="col-md-10 content">
<div>
  <h2>Quản lý tài khoản</h2>

  <!-- Chọn vai trò -->
  <div id="roles" class="mb-3">
    <button class="role-btn" data-role="1"><i class="bi bi-person"></i> Học sinh</button>
    <button class="role-btn" data-role="3"><i class="bi bi-person-badge"></i> Giáo viên</button>
    <button class="role-btn" data-role="2"><i class="bi bi-people"></i> Phụ huynh</button>
    <button class="role-btn" data-role="4"><i class="bi bi-people-fill"></i> Ban giám hiệu</button>
  </div>

  <style>
    .role-btn {
      border: none;
      padding: 10px 16px;
      margin-right: 8px;
      border-radius: 8px;
      background: linear-gradient(180deg,#ffffff,#f3f4f6);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      cursor: pointer;
      font-weight: 600;
      color: #0f172a;
    }
    .role-btn i { margin-right: 8px; }
    .role-btn:hover { transform: translateY(-2px); }
    .role-btn.active { background: linear-gradient(90deg,#06b6d4,#3b82f6); color: white; }
    #searchInput { max-width: 380px; }
    #userTable td button { padding: 6px 10px; border-radius:6px; }
  </style>

  <br>
  <br>
  <!-- Bảng user -->
   <input 
  type="text" 
  id="searchInput" 
  class="form-control mb-3" 
  placeholder="Tìm kiếm username..."
  onkeyup="searchUser()"
/>
  <div class="table-responsive shadow-sm">
  <table id="userTable" class=" table table-bordered text-center align-middle">
    <thead>
      <tr>
        <th style="width: 60px;">Stt</th>
        <th style="width: 200px;">Username</th>
        <th style="width: 150px;">Hành động</th>
      </tr>
    </thead>
    <tbody>
      <!-- Dữ liệu sẽ load bằng JS -->
    </tbody>
  </table>
  </div>
</div>
    </main>

  </div>
</div>
<script>
  const buttons = document.querySelectorAll('.role-btn');
  const tbody = document.querySelector('#userTable tbody');
  let currentUsers = [];
  let currentRole = null;

  async function loadUsersForRole(roleId, btnElement) {
    currentRole = roleId;
    buttons.forEach(b => b.classList.remove('active'));
    if (btnElement) btnElement.classList.add('active');

    const res = await fetch(`/admin/users/${roleId}`);
    const data = await res.json();
    currentUsers = data.data || [];
    renderUsers(currentUsers);
  }

  function renderUsers(list) {
    tbody.innerHTML = '';
    if (!list || !list.length) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-muted py-4">Không có dữ liệu</td></tr>';
      return;
    }

    list.forEach((user, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${user.username}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary" onclick="resetPassword(${user.id})">Đặt lại mật khẩu</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => loadUsersForRole(btn.dataset.role, btn));
  });

function resetPassword(userId) {
    Swal.fire({
      title: "Bạn chắc chắn?",
      text: "Mật khẩu người dùng sẽ được đặt về 1111",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Có, reset!",
      cancelButtonText: "Hủy"
    }).then((result) => {
      if (!result.isConfirmed) return;

      fetch(`/admin/users/reset-password/${userId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => res.json())
      .then(data => {
        Swal.fire({
          icon: "success",
          title: "Thành công",
          text: data.message
        });
      })
      .catch(err => {
        Swal.fire({
          icon: "error",
          title: "Lỗi!",
          text: "Không thể reset mật khẩu"
        });
      });
    });
  }

function searchUser() {
  const keyword = document.getElementById("searchInput").value.toLowerCase().trim();
  if (!currentRole) {
    // If role not selected yet, show helper
    return Swal.fire('Chú ý', 'Vui lòng chọn vai trò trước khi tìm kiếm', 'info');
  }

  // Filter the already loaded list
  const filtered = currentUsers.filter(u => (u.username || '').toLowerCase().includes(keyword));

  // If we have results in the loaded list, render them; otherwise try server-side search
  if (filtered.length > 0 || !keyword) {
    renderUsers(filtered.length ? filtered : currentUsers);
    return;
  }

  // Fallback: ask server for search results for current role
  fetch(`/admin/users/search?q=${encodeURIComponent(keyword)}&role=${encodeURIComponent(currentRole)}`)
    .then(res => res.json())
    .then(data => {
      currentUsers = data.data || [];
      const out = currentUsers.filter(u => (u.username || '').toLowerCase().includes(keyword));
      renderUsers(out);
    })
    .catch(err => console.error(err));
}

</script>
