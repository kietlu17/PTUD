<script>
    let gradeChartInstance = null;
    let passChartInstance = null;

    // --- 1. HÀM GỌI API LẤY DỮ LIỆU ---
    async function loadData() {
        // Lấy giá trị từ các ô lọc (nếu tồn tại trên trang đó)
        const namHocEl = document.getElementById('filterNamHoc');
        const hocKyEl = document.getElementById('filterHocKy');
        const lopEl = document.getElementById('filterLop');
        const monEl = document.getElementById('filterMon');

        const payload = {
            namHoc: namHocEl ? namHocEl.value : '',
            hocKy: hocKyEl ? hocKyEl.value : '',
            idLop: lopEl ? lopEl.value : '',
            idMon: monEl ? monEl.value : ''
        };

        // Hiệu ứng loading nút tìm kiếm (nếu có)
        const btn = document.querySelector('button[onclick="loadData()"]');
        let originalText = '';
        if(btn) {
            originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            btn.disabled = true;
        }

        try {
            const res = await fetch('/thongke/get-data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if (result.success) {
                updateCharts(result.stats);
                updateTable(result.data);
            } else {
                alert('⚠️ Lỗi tải dữ liệu: ' + result.message);
            }
        } catch (err) {
            console.error(err);
            alert('❌ Lỗi kết nối server');
        } finally {
            if(btn) {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    }

    // --- 2. HÀM VẼ/CẬP NHẬT BIỂU ĐỒ ---
    function updateCharts(stats) {
        // A. Biểu đồ Cột (Phân phối điểm)
        const ctxGrade = document.getElementById('gradeChart');
        if (ctxGrade) {
            if (gradeChartInstance) gradeChartInstance.destroy(); // Xóa cũ để vẽ mới

            gradeChartInstance = new Chart(ctxGrade.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Giỏi (≥8.0)', 'Khá (6.5-7.9)', 'Trung Bình (5.0-6.4)', 'Yếu (<5.0)'],
                    datasets: [{
                        label: 'Số lượng học sinh',
                        data: [stats.gioi, stats.kha, stats.tb, stats.yeu], // Lưu ý: stats.tb khớp với controller
                        backgroundColor: ['#22c55e', '#3b82f6', '#eab308', '#ef4444'],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }

        // B. Biểu đồ Tròn (Tỷ lệ Đạt)
        const ctxPass = document.getElementById('passChart');
        if (ctxPass) {
            if (passChartInstance) passChartInstance.destroy();

            passChartInstance = new Chart(ctxPass.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Đạt (≥5.0)', 'Không Đạt (<5.0)'],
                    datasets: [{
                        data: [stats.dat, stats.khongDat],
                        backgroundColor: ['#16a34a', '#dc2626'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    }

    // --- 3. HÀM CẬP NHẬT BẢNG ĐIỂM ---
    function updateTable(data) {
        const tbody = document.getElementById('scoreTableBody');
        const countBadge = document.getElementById('totalCount');
        
        if (countBadge) countBadge.innerText = `${data.length} bản ghi`;
        
        if (tbody) {
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-muted py-4">Không tìm thấy dữ liệu phù hợp</td></tr>';
                return;
            }

            data.forEach(d => {
                let xepLoai = '';
                let badgeClass = '';
                const dtb = parseFloat(d.dtb);

                // Logic xếp loại hiển thị màu sắc
                if (dtb >= 8.0) { xepLoai = 'Giỏi'; badgeClass = 'bg-success'; }
                else if (dtb >= 6.5) { xepLoai = 'Khá'; badgeClass = 'bg-primary'; }
                else if (dtb >= 5.0) { xepLoai = 'TB'; badgeClass = 'bg-warning text-dark'; }
                else { xepLoai = 'Yếu'; badgeClass = 'bg-danger'; }

                const row = `
                    <tr>
                        <td class="text-muted">${d.maHS}</td>
                        <td class="fw-bold text-start">${d.tenHS}</td>
                        <td><span class="badge bg-light text-dark border">${d.lop}</span></td>
                        <td>${d.mon}</td>
                        <td>${d.diemTK || '-'}</td>
                        <td>${d.diemGK || '-'}</td>
                        <td>${d.diemCK || '-'}</td>
                        <td class="fw-bold ${badgeClass.replace('bg-', 'text-')}">${d.dtb || '-'}</td>
                        <td><span class="badge ${badgeClass}">${xepLoai}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    }

    // Tự động tải dữ liệu khi trang vừa mở
    document.addEventListener('DOMContentLoaded', loadData);
</script>