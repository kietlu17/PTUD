<%- include('../../partials/header', { title: 'Nhập Điểm Thi' }) %>
<link rel="stylesheet" href="/styles/nhapdiemthi.css">

<div class="container-fluid">
    <div class="row">

        <%- include('../../partials/nav-sogiaoduc', { profile: profile, currentUrl: currentUrl }) %>

        <main class="col-md-10 content">
            <h4 class="text-center mb-4 fw-bold">NHẬP ĐIỂM THI TUYỂN SINH</h4>

            <!-- BỘ LỌC -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Chọn Trường:</label>
                    <select id="truong" class="form-select">
                        <option value="">-- Chọn Trường --</option>
                        <% truongs.forEach(t=> { %>
                        <option value="<%= t.id %>"><%= t.name %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Chọn Phòng Thi:</label>
                    <div class="select-with-btn">
                                            <select id="phongthi" class="form-select me-2">
                        <option value="">-- Chọn Phòng --</option>
                                            </select>
                                            <button id="phanBtn" class="btn btn-outline-primary btn-sm rounded-pill align-self-center" title="Phân thí sinh vào phòng">Phân phòng</button>
                    </div>
                </div>
            </div>

            <!-- BẢNG THÍ SINH -->
            <table class="table table-bordered text-center align-middle" id="thisinhTable">
                <thead class="table-secondary">
                    <tr>
                        <th>Mã HS</th>
                        <th>Họ Tên</th>
                        <th>Ngày Sinh</th>
                        <th>Toán</th>
                        <th>Ngữ Văn</th>
                        <th>Tiếng Anh</th>
                        <th>Tổng</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="saveAllContainer" style="display:none;" class="text-end mt-3">
                <button class="btn btn-primary" onclick="showSaveAllConfirm()">Lưu tất cả điểm</button>
            </div>
        </main>
    </div>
</div>

<!-- Popup xác nhận -->
<div id="confirmAllPopup" class="popup" style="display:none;">
    <div class="popup-content text-center">
        <h4>Xác nhận lưu tất cả điểm?</h4>
        <p class="text-muted">Vui lòng kiểm tra kỹ toàn bộ điểm đã nhập!</p>
        <button class="btn btn-secondary me-2" onclick="cancelConfirmAll()">Hủy</button>
        <button class="btn btn-success" onclick="saveAllScores()">Xác nhận</button>
    </div>
</div>

<!-- Popup lỗi -->
<div id="errorModal" class="popup" style="display:none;">
    <div class="popup-content text-center">
        <h4 class="text-danger">⚠ Lỗi</h4>
        <p id="errorMessage" class="mt-2"></p>
        <button class="btn btn-danger mt-3" onclick="closeErrorModal()">Đóng</button>
    </div>
</div>

<!-- Popup thành công -->
<div id="successModal" class="popup" style="display:none;">
    <div class="popup-content text-center">
        <h4 class="text-success">✅ Lưu điểm thành công!</h4>
        <button class="btn btn-primary mt-3" onclick="closeSuccessModal()">Đóng</button>
    </div>
</div>

<!-- Popup phân phòng preview -->
<div id="previewAssignPopup" class="popup" style="display:none;">
    <div class="popup-content" style="max-width:900px; width:90%;">
        <h4 class="mb-3">Bản xem trước phân phòng</h4>
        <div id="assignPreviewBody" style="max-height:400px; overflow:auto"></div>
        <div class="text-end mt-3">
            <button class="btn btn-secondary me-2" onclick="closePreview()">Hủy</button>
            <button class="btn btn-success" onclick="confirmAssign()">Xác nhận và lưu</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // Load phòng theo trường
    document.getElementById('truong').addEventListener('change', async function () {
        const res = await fetch(`/sogiaoduc/diemthi/phongthi/${this.value}`);
        const data = await res.json();

        const sel = document.getElementById('phongthi');
        sel.innerHTML = '<option value="">-- Chọn Phòng --</option>';

        data.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    });

    // Load thí sinh
    document.getElementById('phongthi').addEventListener('change', async function () {
        const phongId = this.value;
        const saveAll = document.getElementById("saveAllContainer");
        const tbody = document.querySelector('#thisinhTable tbody');

        saveAll.style.display = "none";
        tbody.innerHTML = "";

        if (!phongId) return;

        const res = await fetch(`/sogiaoduc/diemthi/thisinh/${phongId}`);
        const data = await res.json();

        if (data.length === 0) return;

        data.forEach(ts => {
            const d = ts.diem || {};
            const isLocked = d.toan != null && d.nguvan != null && d.tienganh != null;

            tbody.innerHTML += `
            <tr>
                <td>${ts.mahs}</td>
                <td>${ts.hoten}</td>
                <td>${ts.ngaysinh ? new Date(ts.ngaysinh).toLocaleDateString() : ''}</td>

                <td><input id="toan-${ts.id}" ${isLocked ? 'disabled' : ''} type="number" min="0.25" max="9.75" step="0.25" title="Chỉ cho các phần .25, .5, .75 hoặc số nguyên" 
                    class="form-control form-control-sm" value="${d.toan ?? ''}" oninput="updateTong(${ts.id})"></td>

                <td><input id="nguvan-${ts.id}" ${isLocked ? 'disabled' : ''} type="number" min="0.25" max="9.75" step="0.25" title="Chỉ cho các phần .25, .5, .75 hoặc số nguyên" 
                    class="form-control form-control-sm" value="${d.nguvan ?? ''}" oninput="updateTong(${ts.id})"></td>

                <td><input id="tienganh-${ts.id}" ${isLocked ? 'disabled' : ''} type="number" min="0.25" max="9.75" step="0.25" title="Chỉ cho các phần .25, .5, .75 hoặc số nguyên" 
                    class="form-control form-control-sm" value="${d.tienganh ?? ''}" oninput="updateTong(${ts.id})"></td>

                <td id="tong-${ts.id}">${d.tong ?? '-'}</td>
            </tr>`;
        });

        saveAll.style.display = "block";
    });

    // phân thí sinh vào phòng (preview)
    document.getElementById('phanBtn').addEventListener('click', async function () {
        // call preview endpoint
        const res = await fetch('/sogiaoduc/diemthi/phanphong', { method: 'POST' });
        const data = await res.json();
        if (!data.success) return showErrorPopup(data.error || 'Không thể phân phòng');

        const body = document.getElementById('assignPreviewBody');
        body.innerHTML = '';

                data.assignments.forEach(a => {
                    body.innerHTML += `<div class="assign-preview-item">
                            <div><strong>Trường:</strong> ${a.truongName} — <strong>Phòng:</strong> ${a.phongName}</div>
                            <div class="badge bg-primary text-white">${a.assignedCount} thí sinh</div>
                    </div>`;
                });

        // store assignments to confirm later
        window._lastAssign = data.assignments;
        document.getElementById('previewAssignPopup').style.display = 'flex';
    });
});

// Tính tổng
window.updateTong = (id) => {
    const toan = +document.getElementById(`toan-${id}`).value || 0;
    const nv = +document.getElementById(`nguvan-${id}`).value || 0;
    const ta = +document.getElementById(`tienganh-${id}`).value || 0;

    document.getElementById(`tong-${id}`).innerText = (toan + nv + ta).toFixed(2);
};

// Kiểm tra đúng định dạng điểm: >0 <10 và phần thập phân chỉ 0, .25, .50, .75
function isValidScore(val) {
    if (val === null || val === undefined || val === '') return false;
    const v = parseFloat(val);
    if (!isFinite(v)) return false;
    if (v <= 0 || v >= 10) return false;
    const cents = Math.round((v * 100) % 100);
    return [0,25,50,75].includes(cents);
}

// Lưu tất cả
window.saveAllScores = async () => {
    const rows = document.querySelectorAll('#thisinhTable tbody tr');
    const dsDiem = [];

    // Kiểm tra thiếu điểm và định dạng
    for (let row of rows) {
        const id = row.querySelector("input").id.split("-")[1];

        const toan = document.getElementById(`toan-${id}`).value;
        const nv = document.getElementById(`nguvan-${id}`).value;
        const ta = document.getElementById(`tienganh-${id}`).value;

        if (toan === "" || nv === "" || ta === "") {
            // Tắt popup xác nhận
            document.getElementById('confirmAllPopup').style.display = 'none';

            showErrorPopup("Có học sinh chưa được nhập điểm!");
            return;
        }

        if (!isValidScore(toan)) {
            document.getElementById('confirmAllPopup').style.display = 'none';
            showErrorPopup(`Điểm Toán không hợp lệ cho thí sinh ${row.querySelector('td:nth-child(2)').innerText}. Phải là số >0 và <10, phần thập phân chỉ .25, .5, .75 hoặc nguyên.`);
            return;
        }
        if (!isValidScore(nv)) {
            document.getElementById('confirmAllPopup').style.display = 'none';
            showErrorPopup(`Điểm Ngữ Văn không hợp lệ cho thí sinh ${row.querySelector('td:nth-child(2)').innerText}. Phải là số >0 và <10, phần thập phân chỉ .25, .5, .75 hoặc nguyên.`);
            return;
        }
        if (!isValidScore(ta)) {
            document.getElementById('confirmAllPopup').style.display = 'none';
            showErrorPopup(`Điểm Tiếng Anh không hợp lệ cho thí sinh ${row.querySelector('td:nth-child(2)').innerText}. Phải là số >0 và <10, phần thập phân chỉ .25, .5, .75 hoặc nguyên.`);
            return;
        }

        dsDiem.push({ thisinhid: id, toan: parseFloat(toan), nguvan: parseFloat(nv), tienganh: parseFloat(ta) });
    }

    // Gửi API
    const response = await fetch('/sogiaoduc/diemthi/luu-tatca', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dsDiem })
    });
    const result = await response.json();
    if (!result.success) {
        document.getElementById('confirmAllPopup').style.display = 'none';
        showErrorPopup(result.error || 'Lỗi lưu điểm');
        return;
    }

    // Tắt popup xác nhận
    document.getElementById('confirmAllPopup').style.display = 'none';

    // Khóa input
    rows.forEach(row => {
        row.querySelectorAll("input").forEach(input => input.disabled = true);
    });

    document.getElementById("saveAllContainer").style.display = "none";

    // Mở popup thành công
    document.getElementById('successModal').style.display = 'flex';
};
function closePreview() {
    document.getElementById('previewAssignPopup').style.display = 'none';
}

async function confirmAssign() {
    const assignments = window._lastAssign || [];
    if (!assignments.length) return closePreview();

    // send only phongId and candidate ids
    const payload = assignments.map(a => ({ phongId: a.phongId, candidates: (a.candidates || []).map(c => ({ id: c.id })) }));

    const res = await fetch('/sogiaoduc/diemthi/phanphong/confirm', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assignments: payload })
    });
    const data = await res.json();
    if (!data.success) return showErrorPopup(data.error || 'Không thể lưu phân phòng');

    closePreview();
    Swal.fire('Thành công', 'Đã phân phòng và lưu thành công', 'success').then(() => location.reload());
}

// Popup xác nhận
window.showSaveAllConfirm = () => {
    document.getElementById('confirmAllPopup').style.display = 'flex';
};

window.cancelConfirmAll = () => {
    document.getElementById('confirmAllPopup').style.display = 'none';
};



// Popup lỗi
function showErrorPopup(message) {
    document.getElementById("errorMessage").innerText = message;
    document.getElementById("errorModal").style.display = "flex";
}

window.closeErrorModal = () => {
    document.getElementById('errorModal').style.display = 'none';
};

// Popup thành công
window.closeSuccessModal = () => {
    document.getElementById('successModal').style.display = 'none';
};
</script>