<%- include('../../partials/header', { title: 'Nhập Hạnh Kiểm' }) %>

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
<%- include('../../partials/nav-giaovien') %>
    <!-- Main Content -->
    <main class="col-md-10 content">
    <h1>Danh sách lớp của giáo viên</h1>

<% dsLop.forEach(lop => { %>
  <h2>Lớp: <%= lop.TenLop %> (Số học sinh: <%= lop.hocsinhs.length %>)</h2>

  <form class="hanhkiemForm" action="/giaovien/hanhkiem/<%= giaovienId %>/lop/<%= lop.id %>" method="POST">
    <table class="table table-bordered text-center">
      <thead class="table-secondary">
        <tr>
          <th>STT</th>
          <th>Họ và tên</th>
          <th>Ngày sinh</th>
          <th>Giới tính</th>
          <th>Hạnh kiểm</th>
          <th>Nhận xét</th>
        </tr>
      </thead>
      <tbody>
        <% lop.hocsinhs.forEach((hs, index) => { %>
          <tr>
            <td><%= index + 1 %></td>
            <td><%= hs.HoVaTen %></td>
            <td><%= hs.NgaySinh ? new Date(hs.NgaySinh).toLocaleDateString() : '' %></td>
            <td><%= hs.GioiTinh %></td>
            <td>
              <select name="hanhKiem[<%= hs.id %>]">
                <option value="Tốt" <%= hs.hanhKiem && hs.hanhKiem.LoaiHanhKiem === 'Tốt' ? 'selected' : '' %>>Tốt</option>
                <option value="Khá" <%= hs.hanhKiem && hs.hanhKiem.LoaiHanhKiem === 'Khá' ? 'selected' : '' %>>Khá</option>
                <option value="Trung Bình" <%= hs.hanhKiem && hs.hanhKiem.LoaiHanhKiem === 'Trung Bình' ? 'selected' : '' %>>Trung Bình</option>
                <option value="Yếu" <%= hs.hanhKiem && hs.hanhKiem.LoaiHanhKiem === 'Yếu' ? 'selected' : '' %>>Yếu</option>
              </select>
            </td>
            <td>
              <input type="text" name="nhanXet[<%= hs.id %>]" class="form-control"
                     value="<%= hs.hanhKiem ? hs.hanhKiem.NhanXet : '' %>">
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <button type="submit" class="btn btn-primary mb-4">Lưu Hạnh Kiểm</button>
  </form>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    // Gắn handler cho tất cả form .hanhkiemForm
    document.querySelectorAll('.hanhkiemForm').forEach(form => {
      form.addEventListener('submit', async function (e) {
        e.preventDefault(); // KHÔNG điều hướng sang trang khác

        // Kiểm tra đã chọn hạnh kiểm cho mọi học sinh (select luôn có option, nhưng phòng trường hợp có empty)
        const selects = Array.from(form.querySelectorAll('select[name^="hanhKiem["]'));
        const allSelected = selects.every(s => s.value && s.value.trim() !== '');
        if (!allSelected) {
          Swal.fire({
            icon: 'warning',
            title: 'Chưa chọn đầy đủ!',
            text: 'Vui lòng chọn hạnh kiểm cho tất cả học sinh.',
            confirmButtonColor: '#6c757d'
          });
          return;
        }

        // Chuẩn bị dữ liệu để gửi (application/x-www-form-urlencoded)
        const fd = new FormData(form);
        const body = new URLSearchParams();
        for (const [k, v] of fd.entries()) body.append(k, v);

        try {
          const resp = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body.toString()
          });

          if (!resp.ok) {
            const t = await resp.text();
            throw new Error(t || resp.statusText);
          }

          // server trả JSON { message: '...' }
          let json = null;
          try { json = await resp.json(); } catch (err) { /* ignore */ }

          Swal.fire({
            icon: 'success',
            title: 'Lưu hạnh kiểm thành công!',
            text: json && json.message ? json.message : 'Dữ liệu hạnh kiểm đã được lưu.',
            confirmButtonText: 'OK',
            confirmButtonColor: '#6c757d'
          });

        } catch (error) {
          console.error('Lỗi khi gửi hạnh kiểm:', error);
          Swal.fire({
            icon: 'error',
            title: 'Lỗi lưu',
            text: 'Không thể lưu hạnh kiểm. Vui lòng thử lại.',
            confirmButtonColor: '#6c757d'
          });
        }
      });
    });
    </script>
<% }) %>

        <a href="/giaovien/hanhkiem/<%= giaovienId %>/lop" class="btn btn-secondary mt-3">← Quay lại danh sách lớp</a>
      </div>
    </main>

  </div>
</div>
</body>
</html>
