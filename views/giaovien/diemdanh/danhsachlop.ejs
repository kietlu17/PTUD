<%- include('../../partials/header', { title: 'Điểm Danh Lớp Học' }) %>

<div class="container-fluid">
    <div class="row">

        <%- include('../../partials/nav-giaovien', { title: 'Điểm Danh Lớp Học' }) %>

        <main class="col-md-10 p-4 bg-light">
            <h4 class="text-center fw-bold mb-3 text-primary">
                Điểm danh lớp <%= lop.TenLop %>
            </h4>

            <div class="text-end mb-3">
                <strong>Ngày điểm danh:</strong>
                <%= new Date().toLocaleDateString('vi-VN') %>
            </div>

            <form id="formDiemDanh" action="/giaovien/diemdanh/<%= id %>/lop/<%= lop.id %>" method="POST">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center shadow-sm bg-white">
                        <thead class="table-secondary">
                            <tr>
                                <th rowspan="2">STT</th>
                                <th rowspan="2">Họ và tên</th>
                                <th rowspan="2">Ngày sinh</th>
                                <th rowspan="2">Giới tính</th>
                                <th colspan="4">Trạng thái điểm danh</th>
                            </tr>
                            <tr class="sub-header">
                                <th class="text-primary">Có mặt</th>
                                <th class="text-danger">Vắng (K.Phép)</th>
                                <th class="text-success">Vắng (C.Phép)</th>
                                <th class="text-warning">Đi muộn</th>
                            </tr>
                        </thead>
                        
                        <tbody>
                            <% dsHocSinh.forEach((hs, index) => { %>
                                <tr>
                                    <td><%= index + 1 %></td>   <!-- STT -->
                                    
                                    <td class="text-start ps-3">
                                        <%= hs.HoVaTen %>
                                    </td>
                                    
                                    <td><%= hs.NgaySinh %></td>
                                    <td><%= hs.GioiTinh %></td>

                                    <% if (hs.coPhep) { %>
                                        <td><input type="radio" disabled></td>
                                        <td><input type="radio" disabled></td>
                                        <td>
                                            <input type="radio" checked disabled>
                                            <input type="hidden" name="status_<%= hs.id %>" value="Có phép">
                                        </td>
                                        <td><input type="radio" disabled></td>

                                    <% } else { %>
                                        <td><input type="radio" name="status_<%= hs.id %>" value="Có mặt" required></td>
                                        <td><input type="radio" name="status_<%= hs.id %>" value="Không phép"></td>
                                        <td><input type="radio" name="status_<%= hs.id %>" value="Có phép"></td>
                                        <td><input type="radio" name="status_<%= hs.id %>" value="Trễ"></td>
                                    <% } %>

                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-primary px-4">
                        Lưu điểm danh
                    </button>
                </div>

            </form>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const form = document.getElementById('formDiemDanh');

    form.addEventListener('submit', async function(e) {
        e.preventDefault(); 

        const allSelected = Array.from(form.querySelectorAll('tbody tr')).every(row => {
            const radioChecked = row.querySelector('input[type="radio"]:checked');
            const hasHiddenInput = row.querySelector('input[type="hidden"]'); 
            return radioChecked || hasHiddenInput;
        });

        if (!allSelected) {
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn đủ!',
                text: 'Vui lòng chọn trạng thái cho tất cả học sinh.',
            });
            return;
        }

        try {
            const formData = new FormData(form);
            const data = new URLSearchParams(formData);

            Swal.fire({
                title: 'Đang lưu...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const response = await fetch(form.action, {
                method: 'POST',
                body: data
            });

            const responseText = await response.text();
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (err) {
                console.error("Server Error HTML:", responseText);
                throw new Error("Lỗi Server: " + responseText.substring(0, 100));
            }

            if (response.ok && result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Điểm danh thành công!',
                    confirmButtonText: 'OK',
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(result.message || 'Có lỗi xảy ra');
            }

        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi hệ thống',
                text: error.message,
            });
        }
    });
</script>

<style>
    main { min-height: 100vh; }
    table { border-radius: 6px; overflow: hidden; }
    thead th { background-color: #dee2e6 !important; color: #212529; font-weight: 600; }
    .sub-header th { background-color: #f1f3f5 !important; font-weight: 500; font-size: 14px; }
    td, th { vertical-align: middle !important; font-size: 15px; }
    
    input[type="radio"] { 
        accent-color: #6c757d; 
        width: 18px; 
        height: 18px; 
        cursor: pointer; 
    }
    
    .btn-primary { background-color: #6c757d; border: none; font-weight: 500; }
    .btn-primary:hover { background-color: #5a6268; }
</style>