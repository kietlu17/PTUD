<%- include('../../partials/header', { title: 'Tạo Thời Khóa Biểu' }) %>


<style>
    /* (Giữ nguyên CSS cũ của bạn cho Table và Cell) */
    .tkb-table th, .tkb-table td { text-align: center; vertical-align: middle; height: 60px; }
    .th-ca-hoc { width: 60px; } .th-thu { width: 13.5%; }
    .tkb-cell {
        background-color: #f0f9ff; border: 1px solid #e0f2fe; cursor: pointer;
        border-radius: 8px; padding: 4px; height: 65px;
        display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;
    }
    .tkb-cell:hover { background-color: #bae6fd; transform: translateY(-2px); z-index: 5; }
    .tkb-cell.filled { background-color: #dbeafe; border: 1px solid #3b82f6; }
    .period-badge {
        position: absolute; top: 4px; left: 4px; background-color: #94a3b8; color: white;
        border-radius: 50%; width: 18px; height: 18px; font-size: 0.65rem; display: flex; align-items: center; justify-content: center;
    }
    .cell-subject { font-weight: 800; color: #1e40af; font-size: 0.9rem; }
    .cell-teacher { font-size: 0.75rem; color: #4b5563; }
    /* Style cho ô cố định (Chào cờ) */
    .cell-fixed {
        background-color: #fff7ed; /* Màu cam nhạt */
        border: 1px solid #fed7aa;
        color: #c2410c; /* Chữ cam đậm */
        cursor: default; /* Con trỏ bình thường */
        height: 65px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        text-transform: uppercase;
        position: relative;
        box-shadow: none !important; /* Không đổ bóng khi hover */
    }
    
    /* Badge cho ô cố định */
    .cell-fixed .period-badge {
        background-color: #fb923c; 
    }

    /* Modal Selection Styles */
    .row-selectable { cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background-color 0.2s;;}
    .row-selectable:hover { background-color: #f8fafc; }
    .row-selectable.selected { background-color: rgba(0, 0, 0, 0.6) !important; color: white !important; }
    .row-selectable.selected td {
        background-color: rgba(55, 53, 53, 0.3) !important; /* Đen trong suốt 30% */
        backdrop-filter: blur(2px); /* Hiệu ứng mờ nền nếu cần */
    }
    
    .busy-badge { background-color: #ef4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

    /* Cảnh báo quá tải (Số tiết màu đỏ) */
    .text-overload { color: #dc2626; font-weight: bold; }
    .text-safe { color: #16a34a; font-weight: bold; }

    /* Style cho dòng bị quá tải (Full số tiết) */
    .row-full {
        background-color: #fee2e2;
        color: #991b1b;
        cursor: not-allowed; 
    }

    .row-busy {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }
    .full-badge {
        background-color: #dc2626;
        color: white;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        font-weight: bold;
        display: inline-block;
    }

        /* Nút bấm trong modal */
    .btn-confirm-modal {
        background-color: #16a34a;
        color: white;
        padding: 8px 30px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        transition: 0.2s;
    }
    .btn-confirm-modal:hover { background-color: #15803d; }
    
    .btn-cancel-modal {
        background-color: #f62020;
        color: #ffffff;
        padding: 8px 30px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        transition: 0.2s;
    }
    .btn-cancel-modal:hover { background-color: #c20c0c; }

    .progress-text { font-size: 0.85rem; font-weight: 600; }
    .over-limit { color: #dc2626; } /* Đỏ */
    .within-limit { color: #16a34a; } /* Xanh */
</style>




<div class="container-fluid">
  <div class="row">
    <%- include('../../partials/nav-giaovien') %>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">

        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <table class="table table-bordered tkb-table mb-0">
                    <thead>
                        <tr>
                            <th class="th-ca-hoc">Ca</th>
                            <% ['2', '3', '4', '5', '6', '7'].forEach(d => { %>
                                <th class="th-thu">Thứ <%= d %></th>
                            <% }) %>
                        </tr>
                    </thead>
                   <tbody>
  <% const periods = [1,2,3,4,5,6,7,8,9,10]; %>
  <% const days = ['Hai','Ba','Tư','Năm','Sáu','Bảy']; %>

  <% periods.forEach((tiet) => { %>
    <tr>
      <% if (tiet === 1) { %>
        <td rowspan="5" class="bg-light fw-bold align-middle">SÁNG</td>
      <% } %>
      <% if (tiet === 6) { %>
        <td rowspan="5" class="bg-light fw-bold align-middle">CHIỀU</td>
      <% } %>

      <% days.forEach(thu => { %>
        <td class="p-1">
          <% 
            const item = tkb.find(x => x.Tiet === tiet && x.Thu === thu);
          %>

          <% if (item) { %>
            <div class="tkb-cell filled">
              <div class="period-badge"><%= tiet %></div>
              <div class="cell-subject"><%= item.monHoc?.TenMon || '' %></div>
              <div class="cell-teacher"><%= item.lop?.TenLop || '' %></div>
            </div>
          <% } else { %>
            <div class="tkb-cell">
              <div class="period-badge"><%= tiet %></div>
              <span class="small text-muted">-- Trống --</span>
            </div>
          <% } %>
        </td>
      <% }) %>
    </tr>
  <% }) %>
</tbody>

                </table>
            </div>
        </div>
    </main>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    savedSchedule.forEach(item => {
        const tenGV = item.giaoVien?.HoVaTen || 'Unknown';
        const tenMon = item.monHoc?.TenMon || 'Unknown';

        const thuUI = normalizeDay(item.Thu); // 'Tư' → '4'
        updateCellUI(
          thuUI,
          item.Tiet,
          tenGV,
          tenMon,
          item.id_GiaoVien,
          item.id_MonHoc,
          false
        );
    });
});

</script>


